{"ast":null,"code":"var _jsxFileName = \"/Users/E113938/Library/CloudStorage/OneDrive-RMITUniversity/My Mac Folders/2025/FILTER Project/FILTER/Map Dashboard/Map Demonstrator_backend/src/components/map.js\",\n  _s = $RefreshSig$();\nimport React, { useState, useEffect, useRef } from 'react';\nimport maplibregl from 'maplibre-gl';\nimport 'maplibre-gl/dist/maplibre-gl.css';\n\n// (Legend and AI description components removed per requirements)\n\n// --- START: MAP COMPONENT ---\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nexport default function Map() {\n  _s();\n  const mapContainer = useRef(null);\n  const map = useRef(null);\n  const hoverStateBySource = useRef({}); // track hovered feature ids per source for outlines\n\n  // Definitions for interactive text highlighting\n  const PRECINCT_NAMES = ['Montague', 'Sandridge', 'Lorimer', 'Wirraway', 'Employment Precinct'];\n  const PRECINCT_COLORS = {\n    'Montague': '#3498db',\n    'Sandridge': '#e74c3c',\n    'Lorimer': '#2ecc71',\n    'Wirraway': '#f39c12',\n    'Employment Precinct': '#9b59b6'\n  };\n\n  // --- STATE MANAGEMENT ---\n  const [selectedIndicator, setSelectedIndicator] = useState(null);\n  const [selectedScale, setSelectedScale] = useState(null); // 'sa1' | 'mb' | 'dzn'\n  const [uploading, setUploading] = useState(false);\n  const [uploadedGeojson, setUploadedGeojson] = useState(null);\n  const [selectedProperty, setSelectedProperty] = useState(null);\n  const [propertyOptions, setPropertyOptions] = useState([]);\n  const lastCsvFileRef = useRef(null); // store last uploaded CSV File object\n  const popupPropRef = useRef(null);\n  const [legendInfo, setLegendInfo] = useState(null);\n\n  // Panel widths for map padding\n  const leftPanelWidth = 200;\n  const rightPanelWidth = 0;\n\n  // --- DATA DEFINITIONS ---\n  const legendData = {\n    'Education': {\n      title: 'Education (Total)',\n      items: [{\n        color: '#fee5d9',\n        label: 'low'\n      }, {\n        color: '#fcbba1',\n        label: ''\n      }, {\n        color: '#fc9272',\n        label: ''\n      }, {\n        color: '#fb6a4a',\n        label: ''\n      }, {\n        color: '#ef3b2c',\n        label: ''\n      }, {\n        color: '#cb181d',\n        label: 'high'\n      }]\n    },\n    'Income': {\n      title: 'Income (Total)',\n      items: [{\n        color: '#fcfbfd',\n        label: 'low'\n      }, {\n        color: '#efedf5',\n        label: ''\n      }, {\n        color: '#dadaeb',\n        label: ''\n      }, {\n        color: '#bcbddc',\n        label: ''\n      }, {\n        color: '#9e9ac8',\n        label: ''\n      }, {\n        color: '#807dba',\n        label: ''\n      }, {\n        color: '#6a51a3',\n        label: ''\n      }, {\n        color: '#54278f',\n        label: ''\n      }, {\n        color: '#3f007d',\n        label: 'high'\n      }]\n    },\n    'Occupation': {\n      title: 'Occupation (Total)',\n      items: [{\n        color: '#f7fbff',\n        label: 'low'\n      }, {\n        color: '#deebf7',\n        label: ''\n      }, {\n        color: '#c6dbef',\n        label: ''\n      }, {\n        color: '#9ecae1',\n        label: ''\n      }, {\n        color: '#6baed6',\n        label: ''\n      }, {\n        color: '#4292c6',\n        label: ''\n      }, {\n        color: '#2171b5',\n        label: ''\n      }, {\n        color: '#08519c',\n        label: ''\n      }, {\n        color: '#08306b',\n        label: 'high'\n      }]\n    },\n    'Employment': {\n      title: 'Employment (Total)',\n      items: [{\n        color: '#f1eef6',\n        label: 'low'\n      }, {\n        color: '#d7b5d8',\n        label: ''\n      }, {\n        color: '#c994c7',\n        label: ''\n      }, {\n        color: '#df65b0',\n        label: ''\n      }, {\n        color: '#dd1c77',\n        label: 'high'\n      }]\n    },\n    'POB': {\n      title: 'Place of Birth (Total)',\n      items: [{\n        color: '#edf8e9',\n        label: 'low'\n      }, {\n        color: '#bae4b3',\n        label: ''\n      }, {\n        color: '#74c476',\n        label: ''\n      }, {\n        color: '#31a354',\n        label: ''\n      }, {\n        color: '#006d2c',\n        label: 'high'\n      }]\n    }\n  };\n\n  // DZN filter list requested\n  const DZN_FILTER_SET = new Set([215110001, 215110002, 215110003, 215110004, 215110005, 215110006, 215110007, 215110008, 215110009, 215110010, 215110011, 215110012].map(String));\n  const SA1_FILTER_SET = new Set(['20605151101', '20605151102', '20605151103', '20605151104', '20605151105']);\n  const MB_FILTER_SET = new Set(['20395192000', '20397951000', '20397952000', '20398940000', '20398951000', '20398952000', '20398953000', '20398954000', '20399560000', '20400531000', '20400550000', '20400560000', '20400574000', '20400582000', '20528882000', '20529430000', '20529440000', '20529901000', '20529902000', '20529903000', '20530481000', '20530482000', '20530491000', '20531030000', '20531040000', '20531261000', '20531263000', '20531265000', '20531951000', '20531952000', '20531953000', '20531955000', '20533071000', '20533160000', '20533171000', '20533172000', '20533173000', '20533174000', '20533175000', '20533212000', '20533213000', '20533214000', '20533215000', '20533221000', '20533222000', '20533224000', '20533225000', '20533241000', '20533242000', '20533244000', '20533246000', '20631905370', '20631923570', '20631925300', '20631932830', '20631944740', '20631945490', '20631977930', '20631977940', '20668280000', '20668300000', '20668330000', '20675200000', '20689950000', '21345020000', '21345080000', '21345090000', '21345100000', '21345110000', '21345240000', '21345250000', '21345290000', '21345300000', '21345400000', '21345410000', '21345590000', '21345600000', '21345610000']);\n  const indicatorConfig = {\n    'Education': {\n      path: '/data/education-fb-sa1.geojson',\n      property: 'Education-VIC_Total',\n      source: 'education-data-source'\n    },\n    'Employment': {\n      path: '/data/employment-fb-sa1.geojson',\n      property: 'employment-VIC_Total',\n      source: 'employment-data-source'\n    },\n    'Income': {\n      path: '/data/income-fb-sa1.geojson',\n      property: 'Income-VIC1_Total',\n      source: 'income-data-source'\n    },\n    'POB': {\n      path: '/data/POB-fb-sa1.geojson',\n      property: 'POB-VIC1_Total',\n      source: 'pob-data-source'\n    },\n    'Occupation': {\n      path: '/data/occupation-fb-sa1.geojson',\n      property: 'Occupation-VIC_Total',\n      source: 'occupation-data-source'\n    }\n  };\n\n  // --- HOOKS for Map Lifecycle & Effects ---\n\n  // Main Map Initialization\n  useEffect(() => {\n    if (map.current) return;\n    if (!mapContainer.current) return;\n    map.current = new maplibregl.Map({\n      container: mapContainer.current,\n      style: 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json',\n      scrollZoom: false,\n      boxZoom: false,\n      dragRotate: false,\n      dragPan: false,\n      keyboard: false,\n      doubleClickZoom: false,\n      touchZoomRotate: false,\n      preserveDrawingBuffer: true // Required for exporting map canvas\n    });\n    map.current.on('error', e => console.error('A map error occurred:', e.error ? e.error.message : 'Unknown error'));\n    map.current.on('load', () => {\n      adjustMapBounds();\n      // Add sources\n      const sources = [{\n        name: 'base-outline',\n        path: '/data/fb-sa1-2021-WGS84-boundary.geojson'\n      }, {\n        name: 'employment',\n        path: '/data/employment-fb-sa1.geojson',\n        promoteId: 'SA1_CODE21'\n      }, {\n        name: 'education',\n        path: '/data/education-fb-sa1.geojson',\n        promoteId: 'SA1_CODE21'\n      }, {\n        name: 'pob',\n        path: '/data/POB-fb-sa1.geojson',\n        promoteId: 'SA1_CODE21'\n      }, {\n        name: 'income',\n        path: '/data/income-fb-sa1.geojson',\n        promoteId: 'SA1_CODE21'\n      }, {\n        name: 'occupation',\n        path: '/data/occupation-fb-sa1.geojson',\n        promoteId: 'SA1_CODE21'\n      }, {\n        name: 'precincts',\n        path: '/data/fb-precincts-official-boundary.geojson'\n      }\n      // jobs layers removed per requirements\n      ];\n      sources.forEach(s => {\n        const spec = {\n          type: 'geojson',\n          data: s.path\n        };\n        if (s.promoteId) spec.promoteId = s.promoteId;\n        map.current.addSource(`${s.name}-data-source`, spec);\n      });\n\n      // Define layers for indicators\n      const layers = [{\n        id: 'education-layer',\n        indicatorName: 'Education',\n        source: 'education-data-source',\n        property: indicatorConfig['Education'].property,\n        colors: legendData['Education'].items.map(i => i.color),\n        stops: [0, 100, 200, 300, 400, 500]\n      }, {\n        id: 'employment-layer',\n        indicatorName: 'Employment',\n        source: 'employment-data-source',\n        property: indicatorConfig['Employment'].property,\n        colors: legendData['Employment'].items.map(i => i.color),\n        stops: [0, 100, 200, 300, 400]\n      }, {\n        id: 'income-layer',\n        indicatorName: 'Income',\n        source: 'income-data-source',\n        property: indicatorConfig['Income'].property,\n        colors: legendData['Income'].items.map(i => i.color),\n        stops: [0, 100, 200, 300, 400, 500, 600, 700, 800]\n      }, {\n        id: 'pob-layer',\n        indicatorName: 'POB',\n        source: 'pob-data-source',\n        property: indicatorConfig['POB'].property,\n        colors: legendData['POB'].items.map(i => i.color),\n        stops: [0, 100, 200, 300, 400]\n      }, {\n        id: 'occupation-layer',\n        indicatorName: 'Occupation',\n        source: 'occupation-data-source',\n        property: indicatorConfig['Occupation'].property,\n        colors: legendData['Occupation'].items.map(i => i.color),\n        stops: [0, 100, 200, 300, 400, 500, 600, 700, 800]\n      }];\n      layers.forEach(layer => {\n        // Fill paint\n        let paint;\n        if (layer.type === 'step') {\n          const base = '#ffffff';\n          const stepExpr = ['step', ['to-number', ['get', layer.property]], base];\n          layer.breaks.forEach((b, i) => {\n            stepExpr.push(b, layer.colors[i] || layer.colors[layer.colors.length - 1]);\n          });\n          paint = {\n            'fill-color': stepExpr,\n            'fill-opacity': 0.6\n          };\n        } else {\n          const colorStops = layer.stops.flatMap((stop, i) => [stop, layer.colors[i] || layer.colors[layer.colors.length - 1]]);\n          paint = {\n            'fill-color': ['interpolate', ['linear'], ['to-number', ['get', layer.property]], ...colorStops],\n            'fill-opacity': 0.6\n          };\n        }\n        map.current.addLayer({\n          id: layer.id,\n          type: 'fill',\n          source: layer.source,\n          layout: {\n            visibility: 'none'\n          },\n          paint\n        });\n\n        // Base thin boundary for clear geometry edges (always visible with layer)\n        const baseOutlineId = `${layer.id}-base-outline`;\n        map.current.addLayer({\n          id: baseOutlineId,\n          type: 'line',\n          source: layer.source,\n          layout: {\n            visibility: 'none'\n          },\n          paint: {\n            'line-color': '#666',\n            'line-width': 0.4,\n            'line-opacity': 0.7\n          }\n        });\n\n        // Outline layer that lights up on hover\n        const outlineId = `${layer.id}-hover-outline`;\n        map.current.addLayer({\n          id: outlineId,\n          type: 'line',\n          source: layer.source,\n          layout: {\n            visibility: 'none'\n          },\n          paint: {\n            'line-color': '#111',\n            'line-width': 2.5,\n            'line-opacity': ['case', ['boolean', ['feature-state', 'hover'], false], 1, 0]\n          }\n        });\n\n        // Hover feature-state handlers\n        map.current.on('mousemove', layer.id, e => {\n          if (!e.features || !e.features.length) return;\n          const f = e.features[0];\n          const sourceId = layer.source;\n          const prev = hoverStateBySource.current[sourceId];\n          if (prev !== undefined) {\n            try {\n              map.current.setFeatureState({\n                source: sourceId,\n                id: prev\n              }, {\n                hover: false\n              });\n            } catch (_) {}\n          }\n          hoverStateBySource.current[sourceId] = f.id;\n          try {\n            map.current.setFeatureState({\n              source: sourceId,\n              id: f.id\n            }, {\n              hover: true\n            });\n          } catch (_) {}\n        });\n        map.current.on('mouseleave', layer.id, () => {\n          const sourceId = layer.source;\n          const prev = hoverStateBySource.current[sourceId];\n          if (prev !== undefined) {\n            try {\n              map.current.setFeatureState({\n                source: sourceId,\n                id: prev\n              }, {\n                hover: false\n              });\n            } catch (_) {}\n            hoverStateBySource.current[sourceId] = undefined;\n          }\n        });\n      });\n      map.current.addLayer({\n        id: 'base-outline-layer',\n        type: 'line',\n        source: 'base-outline-data-source',\n        paint: {\n          'line-color': '#444',\n          'line-width': 0.2\n        }\n      });\n      const precinctColorExpression = ['case'];\n      PRECINCT_NAMES.forEach(name => {\n        precinctColorExpression.push(['==', ['get', 'name'], name], PRECINCT_COLORS[name]);\n      });\n      precinctColorExpression.push('#CCC');\n      map.current.addLayer({\n        id: 'precincts-fill-layer',\n        type: 'fill',\n        source: 'precincts-data-source',\n        paint: {\n          'fill-color': '#ffffffff',\n          'fill-opacity': 0.15\n        }\n      });\n      map.current.addLayer({\n        id: 'precincts-shadow-layer',\n        type: 'line',\n        source: 'precincts-data-source',\n        paint: {\n          'line-color': 'rgba(0, 0, 0, 0.4)',\n          'line-width': 7,\n          'line-translate': [2, 2],\n          'line-blur': 4\n        }\n      });\n      map.current.addLayer({\n        id: 'precincts-outline-layer',\n        type: 'line',\n        source: 'precincts-data-source',\n        paint: {\n          'line-color': '#0868ac',\n          'line-width': 2.5,\n          'line-opacity': 0.9\n        }\n      });\n\n      // Precinct click handlers removed (no narrative panel)\n\n      map.current.on('mouseenter', 'precincts-fill-layer', () => {\n        map.current.getCanvas().style.cursor = 'pointer';\n      });\n      map.current.on('mouseleave', 'precincts-fill-layer', () => {\n        map.current.getCanvas().style.cursor = '';\n      });\n    });\n    return () => {\n      if (map.current) {\n        map.current.remove();\n        map.current = null;\n      }\n    };\n  }, []);\n\n  // Adjust map bounds on load\n  const adjustMapBounds = () => {\n    if (!map.current) return;\n    const bounds = [[144.890, -37.850], [144.948, -37.816]];\n    map.current.fitBounds(bounds, {\n      padding: {\n        top: 20,\n        bottom: 20,\n        left: leftPanelWidth,\n        right: rightPanelWidth\n      },\n      duration: 2000,\n      essential: true\n    });\n  };\n\n  // Adjust map bounds on window resize\n  useEffect(() => {\n    function debounce(fn, ms) {\n      let timer;\n      return function (...args) {\n        clearTimeout(timer);\n        timer = setTimeout(() => {\n          fn.apply(this, args);\n        }, ms);\n      };\n    }\n    const debouncedAdjustBounds = () => {\n      if (!map.current) return;\n      const bounds = [[144.890, -37.850], [144.948, -37.816]];\n      map.current.fitBounds(bounds, {\n        padding: {\n          top: 20,\n          bottom: 20,\n          left: leftPanelWidth,\n          right: rightPanelWidth\n        },\n        duration: 0\n      });\n    };\n    const debouncedResizeListener = debounce(debouncedAdjustBounds, 150);\n    window.addEventListener('resize', debouncedResizeListener);\n    return () => window.removeEventListener('resize', debouncedResizeListener);\n  }, []);\n\n  // Toggle visibility of indicator layers\n  useEffect(() => {\n    if (!map.current || !map.current.isStyleLoaded()) return;\n    const allLayerIds = ['education-layer', 'employment-layer', 'income-layer', 'pob-layer', 'occupation-layer'];\n    // Do NOT show preloaded indicator layers when selecting an indicator; we only visualize uploaded CSV output\n    const selectedLayerId = null;\n    if (map.current.getLayer('base-outline-layer')) {\n      map.current.setLayoutProperty('base-outline-layer', 'visibility', selectedIndicator ? 'visible' : 'none');\n    }\n    allLayerIds.forEach(layerId => {\n      if (map.current.getLayer(layerId)) {\n        const vis = layerId === selectedLayerId ? 'visible' : 'none';\n        map.current.setLayoutProperty(layerId, 'visibility', vis);\n        const outlineId = `${layerId}-hover-outline`;\n        const baseOutlineId = `${layerId}-base-outline`;\n        if (map.current.getLayer(outlineId)) map.current.setLayoutProperty(outlineId, 'visibility', vis);\n        if (map.current.getLayer(baseOutlineId)) map.current.setLayoutProperty(baseOutlineId, 'visibility', vis);\n      }\n    });\n  }, [selectedIndicator]);\n\n  // Handle uploaded GeoJSON rendering\n  useEffect(() => {\n    var _dataToRender, _dataToRender$feature;\n    if (!map.current || !map.current.isStyleLoaded()) return;\n    const sourceId = 'uploaded-geojson-source';\n    const fillId = 'uploaded-geojson-fill';\n    const outlineId = 'uploaded-geojson-outline';\n    const hoverOutlineId = 'uploaded-geojson-hover-outline';\n    if (!uploadedGeojson) {\n      if (map.current.getLayer(fillId)) map.current.setLayoutProperty(fillId, 'visibility', 'none');\n      if (map.current.getLayer(outlineId)) map.current.setLayoutProperty(outlineId, 'visibility', 'none');\n      return;\n    }\n\n    // Determine the property to visualize\n    const detectTotalKey = (fc, indicator) => {\n      if (!fc || !fc.features || !fc.features.length) return null;\n      const props = fc.features[0].properties || {};\n      const keys = Object.keys(props);\n      const indicatorKey = (indicator || '').toLowerCase();\n\n      // Explicit cases for special indicators produced by backend\n      if (indicatorKey.includes('industry')) {\n        const exact = keys.find(k => k.toLowerCase() === 'industry specialisation_21');\n        if (exact) return exact;\n        const fuzzy = keys.find(k => k.toLowerCase().includes('industry') && k.toLowerCase().includes('special'));\n        if (fuzzy) return fuzzy;\n      }\n\n      // Prefer job-related totals for Total number of jobs\n      if (indicatorKey.includes('job')) {\n        const candidatesJobs = ['TotJob_21', 'TotalJobs', 'Total_Jobs', 'Jobs_Total', 'Total number of jobs', 'Jobs', 'Job_Total'].map(s => s.toLowerCase());\n        const byExact = keys.find(k => candidatesJobs.includes(k.toLowerCase()));\n        if (byExact) return byExact;\n        const byFuzzy = keys.find(k => k.toLowerCase().includes('job'));\n        if (byFuzzy) return byFuzzy;\n      }\n\n      // Prefer keys containing both indicator name and 'total'\n      let match = keys.find(k => k.toLowerCase().includes('total') && k.toLowerCase().includes(indicatorKey));\n      if (!match) match = keys.find(k => k.toLowerCase().includes('total')) || null;\n      if (match) return match;\n\n      // Fallback: first numeric field that is not an ID\n      const idLike = new Set(['sa1_code', 'sa1_code21', 'dzn_21', 'dzn_code21']);\n      for (const k of keys) {\n        if (idLike.has(k.toLowerCase())) continue;\n        const v = Number(props[k]);\n        if (Number.isFinite(v)) return k;\n      }\n      // Final fallback: first property key\n      return keys[0] || null;\n    };\n\n    // If indicator is DZN-based, filter features to the required DZN list\n    const indLower = (selectedIndicator || '').toLowerCase();\n    const isDznBased = selectedScale === 'dzn' || indLower.includes('industry') || indLower.includes('total') && indLower.includes('jobs');\n    let dataToRender = uploadedGeojson;\n    try {\n      var _uploadedGeojson$feat;\n      if (uploadedGeojson !== null && uploadedGeojson !== void 0 && (_uploadedGeojson$feat = uploadedGeojson.features) !== null && _uploadedGeojson$feat !== void 0 && _uploadedGeojson$feat.length) {\n        // Determine appropriate idKey by scale and filter sets\n        const props = uploadedGeojson.features[0].properties || {};\n        let idKey = null;\n        if (selectedScale === 'dzn') {\n          idKey = Object.keys(props).find(k => k.toLowerCase() === 'dzn_21' || k.toLowerCase() === 'dzn_code21' || k.toLowerCase().includes('dzn')) || 'DZN_21';\n        } else if (selectedScale === 'sa1') {\n          idKey = Object.keys(props).find(k => ['sa1_code', 'sa1_code21', 'sa1_code_2021', 'sa1 (ur)'].includes(k.toLowerCase())) || 'SA1_CODE';\n        } else if (selectedScale === 'mb') {\n          idKey = Object.keys(props).find(k => k.toLowerCase() === 'mb_code21' || k.toLowerCase() === 'mb_code_2021' || k.toLowerCase() === 'mb_code' || k.toLowerCase().includes('mb_code')) || 'MB_CODE21';\n        }\n        const filtered = uploadedGeojson.features.filter(f => {\n          const raw = idKey ? (f.properties || {})[idKey] : undefined;\n          const idStr = String(raw).replace(/\\D/g, '');\n          if (selectedScale === 'dzn') return DZN_FILTER_SET.has(idStr);\n          if (selectedScale === 'sa1') return SA1_FILTER_SET.has(idStr.padStart(11, '0')) || SA1_FILTER_SET.has(idStr);\n          if (selectedScale === 'mb') return MB_FILTER_SET.has(idStr);\n          return true;\n        });\n        dataToRender = {\n          type: 'FeatureCollection',\n          features: filtered\n        };\n      }\n    } catch (_) {}\n\n    // Build property options (numeric fields) and choose default\n    if ((_dataToRender = dataToRender) !== null && _dataToRender !== void 0 && (_dataToRender$feature = _dataToRender.features) !== null && _dataToRender$feature !== void 0 && _dataToRender$feature.length) {\n      const sampleProps = dataToRender.features[0].properties || {};\n      const keys = Object.keys(sampleProps).filter(k => {\n        const kl = k.toLowerCase();\n        if (kl.includes('sa1') || kl.includes('dzn') || kl.includes('id') || kl.includes('code')) return false;\n        const v = Number(sampleProps[k]);\n        return Number.isFinite(v);\n      });\n      setPropertyOptions(keys);\n      if (!selectedProperty) {\n        // Default to TotJob_21 when Total number of jobs indicator is selected\n        const lower = (selectedIndicator || '').toLowerCase();\n        let auto = detectTotalKey(dataToRender, selectedIndicator);\n        if (!auto && lower.includes('job')) {\n          auto = keys.find(k => k.toLowerCase() === 'totjob_21') || keys.find(k => k.toLowerCase().includes('job')) || null;\n        }\n        setSelectedProperty(auto || keys[0] || null);\n      }\n    }\n    const totalKey = selectedProperty || detectTotalKey(dataToRender, selectedIndicator);\n\n    // Keep popup property in sync\n    popupPropRef.current = totalKey;\n\n    // Compute min/max for the selected key\n    const values = (dataToRender.features || []).map(f => Number((f.properties || {})[totalKey])).filter(v => Number.isFinite(v));\n    const min = values.length ? Math.min(...values) : 0;\n    const max = values.length ? Math.max(...values) : 1;\n    // Build equal-interval classes (5 classes)\n    // Red sequential palette (light -> dark)\n    const palette = ['#fee5d9', '#fcbba1', '#fc9272', '#fb6a4a', '#cb181d'];\n    while (palette.length < 5) palette.push(palette[palette.length - 1] || '#888');\n    const n = 5;\n    const width = max - min || 1;\n    const t1 = min + width * (1 / n);\n    const t2 = min + width * (2 / n);\n    const t3 = min + width * (3 / n);\n    const t4 = min + width * (4 / n);\n    const stepExpr = ['step', ['to-number', ['get', totalKey]], palette[0], t1, palette[1], t2, palette[2], t3, palette[3], t4, palette[4]];\n\n    // Prepare legend info ranges\n    const ranges = [{\n      min,\n      max: t1,\n      color: palette[0]\n    }, {\n      min: t1,\n      max: t2,\n      color: palette[1]\n    }, {\n      min: t2,\n      max: t3,\n      color: palette[2]\n    }, {\n      min: t3,\n      max: t4,\n      color: palette[3]\n    }, {\n      min: t4,\n      max,\n      color: palette[4]\n    }];\n    setLegendInfo({\n      title: totalKey,\n      ranges\n    });\n    if (map.current.getSource(sourceId)) {\n      map.current.getSource(sourceId).setData(dataToRender);\n    } else {\n      map.current.addSource(sourceId, {\n        type: 'geojson',\n        data: dataToRender,\n        generateId: true\n      });\n      map.current.addLayer({\n        id: fillId,\n        type: 'fill',\n        source: sourceId,\n        paint: {\n          'fill-color': stepExpr,\n          'fill-opacity': 0.6\n        }\n      });\n      map.current.addLayer({\n        id: outlineId,\n        type: 'line',\n        source: sourceId,\n        paint: {\n          'line-color': '#999',\n          'line-width': 0.8\n        }\n      });\n      // Hover outline layer\n      map.current.addLayer({\n        id: hoverOutlineId,\n        type: 'line',\n        source: sourceId,\n        paint: {\n          'line-color': '#000',\n          'line-width': 3,\n          'line-opacity': ['case', ['boolean', ['feature-state', 'hover'], false], 1, 0]\n        }\n      });\n\n      // Popup on hover/click for uploaded layer\n      const popup = new maplibregl.Popup({\n        closeButton: false,\n        closeOnClick: false\n      });\n      const showPopup = e => {\n        if (!e.features || !e.features.length) return;\n        const f = e.features[0];\n        const props = f.properties || {};\n        const idKey = Object.keys(props).find(k => k.toLowerCase() === 'dzn_21' || k.toLowerCase() === 'dzn_code21' || k.toLowerCase() === 'sa1_code' || k.toLowerCase() === 'sa1_code21');\n        const idVal = idKey ? props[idKey] : '';\n        const k = popupPropRef.current || '';\n        const val = k ? props[k] : '';\n        const html = `<div style=\\\"font-size:12px\\\"><div><strong>${idKey || ''}</strong>: ${idVal}</div><div><strong>${k}</strong>: ${val}</div></div>`;\n        popup.setLngLat(e.lngLat).setHTML(html).addTo(map.current);\n      };\n      map.current.on('mousemove', fillId, showPopup);\n      map.current.on('click', fillId, showPopup);\n      map.current.on('mouseleave', fillId, () => popup.remove());\n\n      // Hover feature-state handlers for uploaded source\n      map.current.on('mousemove', fillId, e => {\n        if (!e.features || !e.features.length) return;\n        const f = e.features[0];\n        const prev = hoverStateBySource.current[sourceId];\n        if (prev !== undefined) {\n          try {\n            map.current.setFeatureState({\n              source: sourceId,\n              id: prev\n            }, {\n              hover: false\n            });\n          } catch (_) {}\n        }\n        hoverStateBySource.current[sourceId] = f.id;\n        try {\n          map.current.setFeatureState({\n            source: sourceId,\n            id: f.id\n          }, {\n            hover: true\n          });\n        } catch (_) {}\n      });\n      map.current.on('mouseleave', fillId, () => {\n        const prev = hoverStateBySource.current[sourceId];\n        if (prev !== undefined) {\n          try {\n            map.current.setFeatureState({\n              source: sourceId,\n              id: prev\n            }, {\n              hover: false\n            });\n          } catch (_) {}\n          hoverStateBySource.current[sourceId] = undefined;\n        }\n      });\n    }\n    // Update paint if layer already exists (e.g., new upload with a different key/range)\n    if (map.current.getLayer(fillId)) {\n      map.current.setPaintProperty(fillId, 'fill-color', stepExpr);\n      map.current.setPaintProperty(fillId, 'fill-opacity', 0.6);\n    }\n    if (map.current.getLayer(fillId)) map.current.setLayoutProperty(fillId, 'visibility', 'visible');\n    if (map.current.getLayer(outlineId)) map.current.setLayoutProperty(outlineId, 'visibility', 'visible');\n    if (map.current.getLayer(hoverOutlineId)) map.current.setLayoutProperty(hoverOutlineId, 'visibility', 'visible');\n  }, [uploadedGeojson, selectedIndicator, selectedProperty]);\n  const reprocessLastCsv = async (indicator, scale) => {\n    const file = lastCsvFileRef.current;\n    if (!file || !indicator || !scale) return;\n    setUploading(true);\n    try {\n      const form = new FormData();\n      form.append('indicator', indicator.toLowerCase());\n      form.append('scale', scale.toLowerCase());\n      form.append('file', file);\n      const attempts = [];\n      const base = process.env.REACT_APP_API_URL;\n      if (base) attempts.push(`${base}/generate`);\n      attempts.push('/generate');\n      if (typeof window !== 'undefined') {\n        const proto = window.location.protocol;\n        const host = window.location.hostname;\n        attempts.push(`${proto}//${host}:8000/generate`);\n      }\n      attempts.push('http://localhost:8000/generate');\n      let res;\n      let lastErr;\n      for (const url of attempts) {\n        try {\n          res = await fetch(url, {\n            method: 'POST',\n            body: form\n          });\n          if (res.ok) break;\n          const text = await res.text();\n          lastErr = new Error(`HTTP ${res.status} at ${url}: ${text}`);\n        } catch (err) {\n          lastErr = err;\n        }\n      }\n      if (!res || !res.ok) throw lastErr || new Error('Upload failed');\n      const geojson = await res.json();\n      setUploadedGeojson(geojson);\n      setSelectedProperty(null);\n    } catch (err) {\n      console.error(err);\n      const msg = `${(err === null || err === void 0 ? void 0 : err.message) || ''}`;\n      // If backend returned a 400 with our scale mismatch message, show a friendlier alert\n      if (/scale mismatch|spatial scale/i.test(msg)) {\n        alert('The selected Spatial scale does not match the identifiers in your CSV. Please choose the correct Spatial scale and try again.');\n      } else {\n        alert(`Failed to reprocess with the new Spatial scale. ${msg}`);\n      }\n    } finally {\n      setUploading(false);\n    }\n  };\n\n  // When spatial scale changes, reprocess the last uploaded CSV (if any)\n  useEffect(() => {\n    if (lastCsvFileRef.current && selectedIndicator && selectedScale) {\n      reprocessLastCsv(selectedIndicator, selectedScale);\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [selectedScale]);\n  const handleFileChange = async e => {\n    var _e$target$files;\n    const file = (_e$target$files = e.target.files) === null || _e$target$files === void 0 ? void 0 : _e$target$files[0];\n    if (!file || !selectedIndicator || !selectedScale) {\n      if (!selectedScale) alert('Please select a spatial scale (SA1 / MB / DZN) before uploading.');\n      return;\n    }\n    lastCsvFileRef.current = file; // remember for future reprocessing\n    setUploading(true);\n    try {\n      const form = new FormData();\n      form.append('indicator', selectedIndicator.toLowerCase());\n      form.append('scale', selectedScale.toLowerCase());\n      form.append('file', file);\n      const attempts = [];\n      const base = process.env.REACT_APP_API_URL;\n      if (base) attempts.push(`${base}/generate`);\n      // CRA dev proxy\n      attempts.push('/generate');\n      // Same host on port 8000\n      if (typeof window !== 'undefined') {\n        const proto = window.location.protocol;\n        const host = window.location.hostname;\n        attempts.push(`${proto}//${host}:8000/generate`);\n      }\n      // Explicit localhost\n      attempts.push('http://localhost:8000/generate');\n      let res;\n      let lastErr;\n      for (const url of attempts) {\n        try {\n          res = await fetch(url, {\n            method: 'POST',\n            body: form\n          });\n          if (res.ok) break;\n          const text = await res.text();\n          lastErr = new Error(`HTTP ${res.status} at ${url}: ${text}`);\n        } catch (err) {\n          lastErr = err;\n        }\n      }\n      if (!res || !res.ok) throw lastErr || new Error('Upload failed');\n      const geojson = await res.json();\n      setUploadedGeojson(geojson);\n      setSelectedProperty(null); // Reset selection on new upload\n    } catch (err) {\n      console.error(err);\n      const msg = `${(err === null || err === void 0 ? void 0 : err.message) || ''}`;\n      if (/scale mismatch|spatial scale/i.test(msg)) {\n        alert('The selected Spatial scale does not match the identifiers in your CSV. Please choose the correct Spatial scale and try again.');\n      } else {\n        alert(`Failed to generate GeoJSON from CSV. ${msg}`);\n      }\n    } finally {\n      setUploading(false);\n      // Reset file input to allow re-upload of same file\n      e.target.value = '';\n    }\n  };\n\n  // (All narrative, search, and export logic removed)\n\n  // --- RENDER METHOD ---\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    style: {\n      position: 'relative',\n      width: '100%',\n      height: 'calc(100vh - 78px)'\n    },\n    children: [/*#__PURE__*/_jsxDEV(\"div\", {\n      ref: mapContainer,\n      style: {\n        position: 'absolute',\n        width: '100%',\n        height: '100%'\n      }\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 602,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      style: {\n        position: 'absolute',\n        top: '1rem',\n        left: '1rem',\n        backgroundColor: 'white',\n        padding: '1rem',\n        borderRadius: '0.5rem',\n        boxShadow: '0 4px 6px rgba(0,0,0,0.1)',\n        width: '320px',\n        zIndex: 10\n      },\n      children: [/*#__PURE__*/_jsxDEV(\"h3\", {\n        style: {\n          fontSize: '1.125rem',\n          fontWeight: 600,\n          marginBottom: '0.5rem'\n        },\n        children: \"Select Indicator\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 605,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"select\", {\n        value: selectedIndicator || '',\n        onChange: e => setSelectedIndicator(e.target.value || null),\n        style: {\n          width: '100%',\n          padding: '0.5rem',\n          border: '1px solid #D1D5DB',\n          borderRadius: '0.375rem',\n          marginBottom: '0.75rem'\n        },\n        children: [/*#__PURE__*/_jsxDEV(\"option\", {\n          value: \"\",\n          children: \"Select\\u2026\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 611,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"option\", {\n          value: \"Education\",\n          children: \"Education\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 612,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"option\", {\n          value: \"Employment\",\n          children: \"Employment\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 613,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"option\", {\n          value: \"Income\",\n          children: \"Income\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 614,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"option\", {\n          value: \"POB\",\n          children: \"POB\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 615,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"option\", {\n          value: \"Occupation\",\n          children: \"Occupation\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 616,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"option\", {\n          value: \"Total number of jobs\",\n          children: \"Total number of jobs\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 617,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"option\", {\n          value: \"Industry specialisation\",\n          children: \"Industry specialisation\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 618,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 606,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"label\", {\n        style: {\n          display: 'block',\n          fontSize: '0.9rem',\n          marginBottom: '0.25rem'\n        },\n        children: \"Spatial scale\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 620,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"select\", {\n        value: selectedScale || '',\n        onChange: e => setSelectedScale(e.target.value || null),\n        style: {\n          width: '100%',\n          padding: '0.5rem',\n          border: '1px solid #D1D5DB',\n          borderRadius: '0.375rem',\n          marginBottom: '0.75rem'\n        },\n        children: [/*#__PURE__*/_jsxDEV(\"option\", {\n          value: \"\",\n          children: \"Select scale\\u2026\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 626,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"option\", {\n          value: \"sa1\",\n          children: \"SA1 level\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 627,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"option\", {\n          value: \"mb\",\n          children: \"MB level\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 628,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"option\", {\n          value: \"dzn\",\n          children: \"DZN level\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 629,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 621,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"label\", {\n        style: {\n          display: 'block',\n          fontSize: '0.9rem',\n          marginBottom: '0.5rem'\n        },\n        children: \"Upload CSV for selected indicator\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 631,\n        columnNumber: 3\n      }, this), /*#__PURE__*/_jsxDEV(\"input\", {\n        type: \"file\",\n        accept: \".csv,text/csv\",\n        onChange: handleFileChange,\n        disabled: !selectedIndicator || !selectedScale || uploading\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 632,\n        columnNumber: 9\n      }, this), uploading && /*#__PURE__*/_jsxDEV(\"div\", {\n        style: {\n          marginTop: '0.5rem',\n          fontSize: '0.85rem'\n        },\n        children: \"Processing\\u2026\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 633,\n        columnNumber: 23\n      }, this), uploadedGeojson && propertyOptions.length > 0 && /*#__PURE__*/_jsxDEV(\"div\", {\n        style: {\n          marginTop: '0.75rem'\n        },\n        children: [/*#__PURE__*/_jsxDEV(\"label\", {\n          style: {\n            display: 'block',\n            fontSize: '0.9rem',\n            marginBottom: '0.25rem'\n          },\n          children: \"Property to visualize\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 638,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"select\", {\n          value: selectedProperty || '',\n          onChange: e => setSelectedProperty(e.target.value || null),\n          style: {\n            width: '100%',\n            padding: '0.5rem',\n            border: '1px solid #D1D5DB',\n            borderRadius: '0.375rem'\n          },\n          children: propertyOptions.map(k => /*#__PURE__*/_jsxDEV(\"option\", {\n            value: k,\n            children: k\n          }, k, false, {\n            fileName: _jsxFileName,\n            lineNumber: 645,\n            columnNumber: 17\n          }, this))\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 639,\n          columnNumber: 13\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 637,\n        columnNumber: 11\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 604,\n      columnNumber: 7\n    }, this), legendInfo && /*#__PURE__*/_jsxDEV(\"div\", {\n      style: {\n        position: 'absolute',\n        right: '1rem',\n        bottom: '2.3rem',\n        backgroundColor: 'white',\n        padding: '0.75rem',\n        borderRadius: '0.5rem',\n        boxShadow: '0 4px 6px rgba(0,0,0,0.1)',\n        zIndex: 10\n      },\n      children: [/*#__PURE__*/_jsxDEV(\"div\", {\n        style: {\n          fontWeight: 600,\n          fontSize: '0.95rem',\n          marginBottom: '0.5rem'\n        },\n        children: legendInfo.title\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 655,\n        columnNumber: 11\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        style: {\n          display: 'flex',\n          flexDirection: 'column',\n          gap: '4px'\n        },\n        children: legendInfo.ranges.map((r, i) => {\n          const fmt = x => {\n            const n = Number(x);\n            if (!Number.isFinite(n)) return String(x);\n            const abs = Math.abs(n);\n            const digits = abs >= 100 ? 0 : abs >= 10 ? 1 : 2;\n            return n.toLocaleString(undefined, {\n              maximumFractionDigits: digits\n            });\n          };\n          return /*#__PURE__*/_jsxDEV(\"div\", {\n            style: {\n              display: 'flex',\n              alignItems: 'center',\n              gap: 8\n            },\n            children: [/*#__PURE__*/_jsxDEV(\"div\", {\n              style: {\n                width: 18,\n                height: 12,\n                backgroundColor: r.color,\n                border: '1px solid #ccc'\n              }\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 667,\n              columnNumber: 19\n            }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n              style: {\n                fontSize: '0.85rem'\n              },\n              children: [fmt(r.min), \" \\u2013 \", fmt(r.max)]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 668,\n              columnNumber: 19\n            }, this)]\n          }, i, true, {\n            fileName: _jsxFileName,\n            lineNumber: 666,\n            columnNumber: 17\n          }, this);\n        })\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 656,\n        columnNumber: 11\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 654,\n      columnNumber: 9\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 601,\n    columnNumber: 5\n  }, this);\n}\n// --- END: MAP COMPONENT ---\n_s(Map, \"HbL3pJOuuEvNfcmRrJMI1t38IJk=\");\n_c = Map;\nvar _c;\n$RefreshReg$(_c, \"Map\");","map":{"version":3,"names":["React","useState","useEffect","useRef","maplibregl","jsxDEV","_jsxDEV","Map","_s","mapContainer","map","hoverStateBySource","PRECINCT_NAMES","PRECINCT_COLORS","selectedIndicator","setSelectedIndicator","selectedScale","setSelectedScale","uploading","setUploading","uploadedGeojson","setUploadedGeojson","selectedProperty","setSelectedProperty","propertyOptions","setPropertyOptions","lastCsvFileRef","popupPropRef","legendInfo","setLegendInfo","leftPanelWidth","rightPanelWidth","legendData","title","items","color","label","DZN_FILTER_SET","Set","String","SA1_FILTER_SET","MB_FILTER_SET","indicatorConfig","path","property","source","current","container","style","scrollZoom","boxZoom","dragRotate","dragPan","keyboard","doubleClickZoom","touchZoomRotate","preserveDrawingBuffer","on","e","console","error","message","adjustMapBounds","sources","name","promoteId","forEach","s","spec","type","data","addSource","layers","id","indicatorName","colors","i","stops","layer","paint","base","stepExpr","breaks","b","push","length","colorStops","flatMap","stop","addLayer","layout","visibility","baseOutlineId","outlineId","features","f","sourceId","prev","undefined","setFeatureState","hover","_","precinctColorExpression","getCanvas","cursor","remove","bounds","fitBounds","padding","top","bottom","left","right","duration","essential","debounce","fn","ms","timer","args","clearTimeout","setTimeout","apply","debouncedAdjustBounds","debouncedResizeListener","window","addEventListener","removeEventListener","isStyleLoaded","allLayerIds","selectedLayerId","getLayer","setLayoutProperty","layerId","vis","_dataToRender","_dataToRender$feature","fillId","hoverOutlineId","detectTotalKey","fc","indicator","props","properties","keys","Object","indicatorKey","toLowerCase","includes","exact","find","k","fuzzy","candidatesJobs","byExact","byFuzzy","match","idLike","has","v","Number","isFinite","indLower","isDznBased","dataToRender","_uploadedGeojson$feat","idKey","filtered","filter","raw","idStr","replace","padStart","sampleProps","kl","lower","auto","totalKey","values","min","Math","max","palette","n","width","t1","t2","t3","t4","ranges","getSource","setData","generateId","popup","Popup","closeButton","closeOnClick","showPopup","idVal","val","html","setLngLat","lngLat","setHTML","addTo","setPaintProperty","reprocessLastCsv","scale","file","form","FormData","append","attempts","process","env","REACT_APP_API_URL","proto","location","protocol","host","hostname","res","lastErr","url","fetch","method","body","ok","text","Error","status","err","geojson","json","msg","test","alert","handleFileChange","_e$target$files","target","files","value","position","height","children","ref","fileName","_jsxFileName","lineNumber","columnNumber","backgroundColor","borderRadius","boxShadow","zIndex","fontSize","fontWeight","marginBottom","onChange","border","display","accept","disabled","marginTop","flexDirection","gap","r","fmt","x","abs","digits","toLocaleString","maximumFractionDigits","alignItems","_c","$RefreshReg$"],"sources":["/Users/E113938/Library/CloudStorage/OneDrive-RMITUniversity/My Mac Folders/2025/FILTER Project/FILTER/Map Dashboard/Map Demonstrator_backend/src/components/map.js"],"sourcesContent":["import React, { useState, useEffect, useRef } from 'react';\nimport maplibregl from 'maplibre-gl';\nimport 'maplibre-gl/dist/maplibre-gl.css';\n\n// (Legend and AI description components removed per requirements)\n\n\n// --- START: MAP COMPONENT ---\nexport default function Map() {\n  const mapContainer = useRef(null);\n  const map = useRef(null);\n  const hoverStateBySource = useRef({}); // track hovered feature ids per source for outlines\n\n  // Definitions for interactive text highlighting\n  const PRECINCT_NAMES = ['Montague', 'Sandridge', 'Lorimer', 'Wirraway', 'Employment Precinct'];\n  const PRECINCT_COLORS = {\n    'Montague': '#3498db',\n    'Sandridge': '#e74c3c',\n    'Lorimer': '#2ecc71',\n    'Wirraway': '#f39c12',\n    'Employment Precinct': '#9b59b6'\n  };\n\n  // --- STATE MANAGEMENT ---\n  const [selectedIndicator, setSelectedIndicator] = useState(null);\n  const [selectedScale, setSelectedScale] = useState(null); // 'sa1' | 'mb' | 'dzn'\n  const [uploading, setUploading] = useState(false);\n  const [uploadedGeojson, setUploadedGeojson] = useState(null);\n  const [selectedProperty, setSelectedProperty] = useState(null);\n  const [propertyOptions, setPropertyOptions] = useState([]);\n  const lastCsvFileRef = useRef(null); // store last uploaded CSV File object\n  const popupPropRef = useRef(null);\n  const [legendInfo, setLegendInfo] = useState(null);\n\n  // Panel widths for map padding\n  const leftPanelWidth = 200;\n  const rightPanelWidth = 0;\n\n  // --- DATA DEFINITIONS ---\n  const legendData = {\n    'Education': {\n      title: 'Education (Total)',\n      items: [ { color: '#fee5d9', label: 'low' }, { color: '#fcbba1', label: '' }, { color: '#fc9272', label: '' }, { color: '#fb6a4a', label: '' }, { color: '#ef3b2c', label: '' }, { color: '#cb181d', label: 'high' } ]\n    },\n    'Income': {\n      title: 'Income (Total)',\n      items: [ { color: '#fcfbfd', label: 'low' }, { color: '#efedf5', label: '' }, { color: '#dadaeb', label: '' }, { color: '#bcbddc', label: '' }, { color: '#9e9ac8', label: '' }, { color: '#807dba', label: '' }, { color: '#6a51a3', label: '' }, { color: '#54278f', label: '' }, { color: '#3f007d', label: 'high' } ]\n    },\n    'Occupation': {\n      title: 'Occupation (Total)',\n      items: [ { color: '#f7fbff', label: 'low' }, { color: '#deebf7', label: '' }, { color: '#c6dbef', label: '' }, { color: '#9ecae1', label: '' }, { color: '#6baed6', label: '' }, { color: '#4292c6', label: '' }, { color: '#2171b5', label: '' }, { color: '#08519c', label: '' }, { color: '#08306b', label: 'high' } ]\n    },\n    'Employment': {\n      title: 'Employment (Total)',\n      items: [ { color: '#f1eef6', label: 'low' }, { color: '#d7b5d8', label: '' }, { color: '#c994c7', label: '' }, { color: '#df65b0', label: '' }, { color: '#dd1c77', label: 'high' } ]\n    },\n    'POB': {\n      title: 'Place of Birth (Total)',\n      items: [ { color: '#edf8e9', label: 'low' }, { color: '#bae4b3', label: '' }, { color: '#74c476', label: '' }, { color: '#31a354', label: '' }, { color: '#006d2c', label: 'high' } ]\n    }\n  };\n\n  // DZN filter list requested\n  const DZN_FILTER_SET = new Set([\n    215110001, 215110002, 215110003, 215110004, 215110005, 215110006,\n    215110007, 215110008, 215110009, 215110010, 215110011, 215110012\n  ].map(String));\n\n  const SA1_FILTER_SET = new Set([\n    '20605151101','20605151102','20605151103','20605151104','20605151105'\n  ]);\n\n  const MB_FILTER_SET = new Set([\n    '20395192000','20397951000','20397952000','20398940000','20398951000','20398952000','20398953000','20398954000','20399560000','20400531000','20400550000','20400560000','20400574000','20400582000','20528882000','20529430000','20529440000','20529901000','20529902000','20529903000','20530481000','20530482000','20530491000','20531030000','20531040000','20531261000','20531263000','20531265000','20531951000','20531952000','20531953000','20531955000','20533071000','20533160000','20533171000','20533172000','20533173000','20533174000','20533175000','20533212000','20533213000','20533214000','20533215000','20533221000','20533222000','20533224000','20533225000','20533241000','20533242000','20533244000','20533246000','20631905370','20631923570','20631925300','20631932830','20631944740','20631945490','20631977930','20631977940','20668280000','20668300000','20668330000','20675200000','20689950000','21345020000','21345080000','21345090000','21345100000','21345110000','21345240000','21345250000','21345290000','21345300000','21345400000','21345410000','21345590000','21345600000','21345610000'\n  ]);\n\n  const indicatorConfig = {\n    'Education': { path: '/data/education-fb-sa1.geojson', property: 'Education-VIC_Total', source: 'education-data-source' },\n    'Employment': { path: '/data/employment-fb-sa1.geojson', property: 'employment-VIC_Total', source: 'employment-data-source' },\n    'Income': { path: '/data/income-fb-sa1.geojson', property: 'Income-VIC1_Total', source: 'income-data-source' },\n    'POB': { path: '/data/POB-fb-sa1.geojson', property: 'POB-VIC1_Total', source: 'pob-data-source' },\n    'Occupation': { path: '/data/occupation-fb-sa1.geojson', property: 'Occupation-VIC_Total', source: 'occupation-data-source' }\n  };\n\n  // --- HOOKS for Map Lifecycle & Effects ---\n\n  // Main Map Initialization\n  useEffect(() => {\n    if (map.current) return;\n    if (!mapContainer.current) return;\n\n    map.current = new maplibregl.Map({\n      container: mapContainer.current,\n      style: 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json',\n      scrollZoom: false, boxZoom: false, dragRotate: false, dragPan: false,\n      keyboard: false, doubleClickZoom: false, touchZoomRotate: false,\n      preserveDrawingBuffer: true // Required for exporting map canvas\n    });\n\n    map.current.on('error', (e) => console.error('A map error occurred:', e.error ? e.error.message : 'Unknown error'));\n\n    map.current.on('load', () => {\n      adjustMapBounds();\n      // Add sources\n      const sources = [\n        { name: 'base-outline', path: '/data/fb-sa1-2021-WGS84-boundary.geojson' },\n        { name: 'employment', path: '/data/employment-fb-sa1.geojson', promoteId: 'SA1_CODE21' },\n        { name: 'education', path: '/data/education-fb-sa1.geojson', promoteId: 'SA1_CODE21' },\n        { name: 'pob', path: '/data/POB-fb-sa1.geojson', promoteId: 'SA1_CODE21' },\n        { name: 'income', path: '/data/income-fb-sa1.geojson', promoteId: 'SA1_CODE21' },\n        { name: 'occupation', path: '/data/occupation-fb-sa1.geojson', promoteId: 'SA1_CODE21' },\n        { name: 'precincts', path: '/data/fb-precincts-official-boundary.geojson' },\n        // jobs layers removed per requirements\n      ];\n      sources.forEach(s => {\n        const spec = { type: 'geojson', data: s.path };\n        if (s.promoteId) spec.promoteId = s.promoteId;\n        map.current.addSource(`${s.name}-data-source`, spec);\n      });\n\n      // Define layers for indicators\n      const layers = [\n        { id: 'education-layer', indicatorName: 'Education', source: 'education-data-source', property: indicatorConfig['Education'].property, colors: legendData['Education'].items.map(i => i.color), stops: [0, 100, 200, 300, 400, 500] },\n        { id: 'employment-layer', indicatorName: 'Employment', source: 'employment-data-source', property: indicatorConfig['Employment'].property, colors: legendData['Employment'].items.map(i => i.color), stops: [0, 100, 200, 300, 400] },\n        { id: 'income-layer', indicatorName: 'Income', source: 'income-data-source', property: indicatorConfig['Income'].property, colors: legendData['Income'].items.map(i => i.color), stops: [0, 100, 200, 300, 400, 500, 600, 700, 800] },\n        { id: 'pob-layer', indicatorName: 'POB', source: 'pob-data-source', property: indicatorConfig['POB'].property, colors: legendData['POB'].items.map(i => i.color), stops: [0, 100, 200, 300, 400] },\n        { id: 'occupation-layer', indicatorName: 'Occupation', source: 'occupation-data-source', property: indicatorConfig['Occupation'].property, colors: legendData['Occupation'].items.map(i => i.color), stops: [0, 100, 200, 300, 400, 500, 600, 700, 800] }\n      ];\n\n      layers.forEach(layer => {\n        // Fill paint\n        let paint;\n        if (layer.type === 'step') {\n          const base = '#ffffff';\n          const stepExpr = ['step', ['to-number', ['get', layer.property]], base];\n          layer.breaks.forEach((b, i) => { stepExpr.push(b, layer.colors[i] || layer.colors[layer.colors.length - 1]); });\n          paint = { 'fill-color': stepExpr, 'fill-opacity': 0.6 };\n        } else {\n          const colorStops = layer.stops.flatMap((stop, i) => [stop, layer.colors[i] || layer.colors[layer.colors.length - 1]]);\n          paint = { 'fill-color': ['interpolate', ['linear'], ['to-number', ['get', layer.property]], ...colorStops], 'fill-opacity': 0.6 };\n        }\n        map.current.addLayer({ id: layer.id, type: 'fill', source: layer.source, layout: { visibility: 'none' }, paint });\n\n        // Base thin boundary for clear geometry edges (always visible with layer)\n        const baseOutlineId = `${layer.id}-base-outline`;\n        map.current.addLayer({\n          id: baseOutlineId,\n          type: 'line',\n          source: layer.source,\n          layout: { visibility: 'none' },\n          paint: { 'line-color': '#666', 'line-width': 0.4, 'line-opacity': 0.7 }\n        });\n\n  // Outline layer that lights up on hover\n  const outlineId = `${layer.id}-hover-outline`;\n        map.current.addLayer({\n          id: outlineId,\n          type: 'line',\n          source: layer.source,\n          layout: { visibility: 'none' },\n          paint: {\n            'line-color': '#111',\n            'line-width': 2.5,\n            'line-opacity': ['case', ['boolean', ['feature-state', 'hover'], false], 1, 0]\n          }\n        });\n\n        // Hover feature-state handlers\n        map.current.on('mousemove', layer.id, (e) => {\n          if (!e.features || !e.features.length) return;\n          const f = e.features[0];\n          const sourceId = layer.source;\n          const prev = hoverStateBySource.current[sourceId];\n          if (prev !== undefined) {\n            try { map.current.setFeatureState({ source: sourceId, id: prev }, { hover: false }); } catch (_) {}\n          }\n          hoverStateBySource.current[sourceId] = f.id;\n          try { map.current.setFeatureState({ source: sourceId, id: f.id }, { hover: true }); } catch (_) {}\n        });\n        map.current.on('mouseleave', layer.id, () => {\n          const sourceId = layer.source;\n          const prev = hoverStateBySource.current[sourceId];\n          if (prev !== undefined) {\n            try { map.current.setFeatureState({ source: sourceId, id: prev }, { hover: false }); } catch (_) {}\n            hoverStateBySource.current[sourceId] = undefined;\n          }\n        });\n      });\n\n      map.current.addLayer({\n        id: 'base-outline-layer', type: 'line', source: 'base-outline-data-source',\n        paint: { 'line-color': '#444', 'line-width': 0.2 }\n      });\n      \n      const precinctColorExpression = ['case'];\n      PRECINCT_NAMES.forEach(name => {\n          precinctColorExpression.push(['==', ['get', 'name'], name], PRECINCT_COLORS[name]);\n      });\n      precinctColorExpression.push('#CCC'); \n\n     map.current.addLayer({\n        id: 'precincts-fill-layer', type: 'fill', source: 'precincts-data-source',\n        paint: { 'fill-color': '#ffffffff', 'fill-opacity': 0.15 }\n      });\n      map.current.addLayer({\n        id: 'precincts-shadow-layer', type: 'line', source: 'precincts-data-source',\n        paint: { 'line-color': 'rgba(0, 0, 0, 0.4)', 'line-width': 7, 'line-translate': [2, 2], 'line-blur': 4 }\n      });\n      map.current.addLayer({\n          id: 'precincts-outline-layer', type: 'line', source: 'precincts-data-source',\n          paint: { 'line-color': '#0868ac', 'line-width': 2.5, 'line-opacity': 0.9 }\n      });\n\n  // Precinct click handlers removed (no narrative panel)\n\n      map.current.on('mouseenter', 'precincts-fill-layer', () => { map.current.getCanvas().style.cursor = 'pointer'; });\n      map.current.on('mouseleave', 'precincts-fill-layer', () => { map.current.getCanvas().style.cursor = ''; });\n    });\n\n    return () => { if (map.current) { map.current.remove(); map.current = null; } };\n  }, []);\n\n  // Adjust map bounds on load\n  const adjustMapBounds = () => {\n    if (!map.current) return;\n    const bounds = [ [144.890, -37.850], [144.948, -37.816] ];\n    map.current.fitBounds(bounds, {\n      padding: { top: 20, bottom: 20, left: leftPanelWidth, right: rightPanelWidth },\n      duration: 2000, essential: true\n    });\n  };\n\n  // Adjust map bounds on window resize\n  useEffect(() => {\n    function debounce(fn, ms) {\n      let timer;\n      return function(...args) { clearTimeout(timer); timer = setTimeout(() => { fn.apply(this, args); }, ms); };\n    }\n    const debouncedAdjustBounds = () => {\n      if (!map.current) return;\n      const bounds = [ [144.890, -37.850], [144.948, -37.816] ];\n      map.current.fitBounds(bounds, { padding: { top: 20, bottom: 20, left: leftPanelWidth, right: rightPanelWidth }, duration: 0 });\n    };\n    const debouncedResizeListener = debounce(debouncedAdjustBounds, 150);\n    window.addEventListener('resize', debouncedResizeListener);\n    return () => window.removeEventListener('resize', debouncedResizeListener);\n  }, []);\n\n  // Toggle visibility of indicator layers\n  useEffect(() => {\n    if (!map.current || !map.current.isStyleLoaded()) return;\n    const allLayerIds = [\n      'education-layer',\n      'employment-layer',\n      'income-layer',\n      'pob-layer',\n      'occupation-layer'\n    ];\n  // Do NOT show preloaded indicator layers when selecting an indicator; we only visualize uploaded CSV output\n  const selectedLayerId = null;\n\n    if (map.current.getLayer('base-outline-layer')) {\n        map.current.setLayoutProperty('base-outline-layer', 'visibility', selectedIndicator ? 'visible' : 'none');\n    }\n\n    allLayerIds.forEach(layerId => {\n      if (map.current.getLayer(layerId)) {\n        const vis = layerId === selectedLayerId ? 'visible' : 'none';\n        map.current.setLayoutProperty(layerId, 'visibility', vis);\n  const outlineId = `${layerId}-hover-outline`;\n  const baseOutlineId = `${layerId}-base-outline`;\n  if (map.current.getLayer(outlineId)) map.current.setLayoutProperty(outlineId, 'visibility', vis);\n  if (map.current.getLayer(baseOutlineId)) map.current.setLayoutProperty(baseOutlineId, 'visibility', vis);\n      }\n    });\n  }, [selectedIndicator]);\n\n  // Handle uploaded GeoJSON rendering\n  useEffect(() => {\n    if (!map.current || !map.current.isStyleLoaded()) return;\n  const sourceId = 'uploaded-geojson-source';\n  const fillId = 'uploaded-geojson-fill';\n  const outlineId = 'uploaded-geojson-outline';\n  const hoverOutlineId = 'uploaded-geojson-hover-outline';\n\n    if (!uploadedGeojson) {\n      if (map.current.getLayer(fillId)) map.current.setLayoutProperty(fillId, 'visibility', 'none');\n      if (map.current.getLayer(outlineId)) map.current.setLayoutProperty(outlineId, 'visibility', 'none');\n      return;\n    }\n\n    // Determine the property to visualize\n    const detectTotalKey = (fc, indicator) => {\n      if (!fc || !fc.features || !fc.features.length) return null;\n      const props = fc.features[0].properties || {};\n      const keys = Object.keys(props);\n      const indicatorKey = (indicator || '').toLowerCase();\n\n      // Explicit cases for special indicators produced by backend\n      if (indicatorKey.includes('industry')) {\n        const exact = keys.find(k => k.toLowerCase() === 'industry specialisation_21');\n        if (exact) return exact;\n        const fuzzy = keys.find(k => k.toLowerCase().includes('industry') && k.toLowerCase().includes('special'));\n        if (fuzzy) return fuzzy;\n      }\n\n      // Prefer job-related totals for Total number of jobs\n      if (indicatorKey.includes('job')) {\n        const candidatesJobs = [\n          'TotJob_21', 'TotalJobs', 'Total_Jobs', 'Jobs_Total', 'Total number of jobs', 'Jobs', 'Job_Total'\n        ].map(s => s.toLowerCase());\n        const byExact = keys.find(k => candidatesJobs.includes(k.toLowerCase()));\n        if (byExact) return byExact;\n        const byFuzzy = keys.find(k => k.toLowerCase().includes('job'));\n        if (byFuzzy) return byFuzzy;\n      }\n\n      // Prefer keys containing both indicator name and 'total'\n      let match = keys.find(k => k.toLowerCase().includes('total') && k.toLowerCase().includes(indicatorKey));\n      if (!match) match = keys.find(k => k.toLowerCase().includes('total')) || null;\n\n      if (match) return match;\n\n      // Fallback: first numeric field that is not an ID\n      const idLike = new Set(['sa1_code', 'sa1_code21', 'dzn_21', 'dzn_code21']);\n      for (const k of keys) {\n        if (idLike.has(k.toLowerCase())) continue;\n        const v = Number(props[k]);\n        if (Number.isFinite(v)) return k;\n      }\n      // Final fallback: first property key\n      return keys[0] || null;\n    };\n\n    // If indicator is DZN-based, filter features to the required DZN list\n  const indLower = (selectedIndicator || '').toLowerCase();\n  const isDznBased = selectedScale === 'dzn' || indLower.includes('industry') || (indLower.includes('total') && indLower.includes('jobs'));\n    let dataToRender = uploadedGeojson;\n    try {\n      if (uploadedGeojson?.features?.length) {\n        // Determine appropriate idKey by scale and filter sets\n        const props = uploadedGeojson.features[0].properties || {};\n        let idKey = null;\n        if (selectedScale === 'dzn') {\n          idKey = Object.keys(props).find(k => k.toLowerCase() === 'dzn_21' || k.toLowerCase() === 'dzn_code21' || k.toLowerCase().includes('dzn')) || 'DZN_21';\n        } else if (selectedScale === 'sa1') {\n          idKey = Object.keys(props).find(k => ['sa1_code','sa1_code21','sa1_code_2021','sa1 (ur)'].includes(k.toLowerCase())) || 'SA1_CODE';\n        } else if (selectedScale === 'mb') {\n          idKey = Object.keys(props).find(k => k.toLowerCase()==='mb_code21' || k.toLowerCase()==='mb_code_2021' || k.toLowerCase()==='mb_code' || k.toLowerCase().includes('mb_code')) || 'MB_CODE21';\n        }\n\n        const filtered = uploadedGeojson.features.filter(f => {\n          const raw = idKey ? (f.properties || {})[idKey] : undefined;\n          const idStr = String(raw).replace(/\\D/g, '');\n          if (selectedScale === 'dzn') return DZN_FILTER_SET.has(idStr);\n          if (selectedScale === 'sa1') return SA1_FILTER_SET.has(idStr.padStart(11,'0')) || SA1_FILTER_SET.has(idStr);\n          if (selectedScale === 'mb') return MB_FILTER_SET.has(idStr);\n          return true;\n        });\n        dataToRender = { type: 'FeatureCollection', features: filtered };\n      }\n    } catch (_) {}\n\n    // Build property options (numeric fields) and choose default\n    if (dataToRender?.features?.length) {\n      const sampleProps = dataToRender.features[0].properties || {};\n      const keys = Object.keys(sampleProps).filter(k => {\n        const kl = k.toLowerCase();\n        if (kl.includes('sa1') || kl.includes('dzn') || kl.includes('id') || kl.includes('code')) return false;\n        const v = Number(sampleProps[k]);\n        return Number.isFinite(v);\n      });\n      setPropertyOptions(keys);\n      if (!selectedProperty) {\n        // Default to TotJob_21 when Total number of jobs indicator is selected\n        const lower = (selectedIndicator || '').toLowerCase();\n        let auto = detectTotalKey(dataToRender, selectedIndicator);\n        if (!auto && lower.includes('job')) {\n          auto = keys.find(k => k.toLowerCase() === 'totjob_21') || keys.find(k => k.toLowerCase().includes('job')) || null;\n        }\n        setSelectedProperty(auto || keys[0] || null);\n      }\n    }\n\n    const totalKey = selectedProperty || detectTotalKey(dataToRender, selectedIndicator);\n\n    // Keep popup property in sync\n    popupPropRef.current = totalKey;\n\n    // Compute min/max for the selected key\n    const values = (dataToRender.features || [])\n      .map(f => Number((f.properties || {})[totalKey]))\n      .filter(v => Number.isFinite(v));\n    const min = values.length ? Math.min(...values) : 0;\n    const max = values.length ? Math.max(...values) : 1;\n    // Build equal-interval classes (5 classes)\n    // Red sequential palette (light -> dark)\n    const palette = [\n      '#fee5d9', '#fcbba1', '#fc9272', '#fb6a4a', '#cb181d'\n    ];\n    while (palette.length < 5) palette.push(palette[palette.length - 1] || '#888');\n    const n = 5;\n    const width = (max - min) || 1;\n    const t1 = min + width * (1 / n);\n    const t2 = min + width * (2 / n);\n    const t3 = min + width * (3 / n);\n    const t4 = min + width * (4 / n);\n    const stepExpr = ['step', ['to-number', ['get', totalKey]], palette[0], t1, palette[1], t2, palette[2], t3, palette[3], t4, palette[4]];\n\n    // Prepare legend info ranges\n    const ranges = [\n      { min, max: t1, color: palette[0] },\n      { min: t1, max: t2, color: palette[1] },\n      { min: t2, max: t3, color: palette[2] },\n      { min: t3, max: t4, color: palette[3] },\n      { min: t4, max, color: palette[4] },\n    ];\n    setLegendInfo({ title: totalKey, ranges });\n\n    if (map.current.getSource(sourceId)) {\n      map.current.getSource(sourceId).setData(dataToRender);\n    } else {\n      map.current.addSource(sourceId, { type: 'geojson', data: dataToRender, generateId: true });\n  map.current.addLayer({ id: fillId, type: 'fill', source: sourceId, paint: { 'fill-color': stepExpr, 'fill-opacity': 0.6 } });\n      map.current.addLayer({ id: outlineId, type: 'line', source: sourceId, paint: { 'line-color': '#999', 'line-width': 0.8 } });\n      // Hover outline layer\n      map.current.addLayer({\n        id: hoverOutlineId,\n        type: 'line',\n        source: sourceId,\n        paint: {\n          'line-color': '#000',\n          'line-width': 3,\n          'line-opacity': ['case', ['boolean', ['feature-state', 'hover'], false], 1, 0]\n        }\n      });\n\n      // Popup on hover/click for uploaded layer\n      const popup = new maplibregl.Popup({ closeButton: false, closeOnClick: false });\n      const showPopup = (e) => {\n        if (!e.features || !e.features.length) return;\n        const f = e.features[0];\n        const props = f.properties || {};\n        const idKey = Object.keys(props).find(k => k.toLowerCase() === 'dzn_21' || k.toLowerCase() === 'dzn_code21' || k.toLowerCase() === 'sa1_code' || k.toLowerCase() === 'sa1_code21');\n        const idVal = idKey ? props[idKey] : '';\n        const k = popupPropRef.current || '';\n        const val = k ? props[k] : '';\n        const html = `<div style=\\\"font-size:12px\\\"><div><strong>${idKey || ''}</strong>: ${idVal}</div><div><strong>${k}</strong>: ${val}</div></div>`;\n        popup.setLngLat(e.lngLat).setHTML(html).addTo(map.current);\n      };\n      map.current.on('mousemove', fillId, showPopup);\n      map.current.on('click', fillId, showPopup);\n      map.current.on('mouseleave', fillId, () => popup.remove());\n\n      // Hover feature-state handlers for uploaded source\n      map.current.on('mousemove', fillId, (e) => {\n        if (!e.features || !e.features.length) return;\n        const f = e.features[0];\n        const prev = hoverStateBySource.current[sourceId];\n        if (prev !== undefined) {\n          try { map.current.setFeatureState({ source: sourceId, id: prev }, { hover: false }); } catch (_) {}\n        }\n        hoverStateBySource.current[sourceId] = f.id;\n        try { map.current.setFeatureState({ source: sourceId, id: f.id }, { hover: true }); } catch (_) {}\n      });\n      map.current.on('mouseleave', fillId, () => {\n        const prev = hoverStateBySource.current[sourceId];\n        if (prev !== undefined) {\n          try { map.current.setFeatureState({ source: sourceId, id: prev }, { hover: false }); } catch (_) {}\n          hoverStateBySource.current[sourceId] = undefined;\n        }\n      });\n    }\n    // Update paint if layer already exists (e.g., new upload with a different key/range)\n    if (map.current.getLayer(fillId)) {\n      map.current.setPaintProperty(fillId, 'fill-color', stepExpr);\n      map.current.setPaintProperty(fillId, 'fill-opacity', 0.6);\n    }\n  if (map.current.getLayer(fillId)) map.current.setLayoutProperty(fillId, 'visibility', 'visible');\n  if (map.current.getLayer(outlineId)) map.current.setLayoutProperty(outlineId, 'visibility', 'visible');\n  if (map.current.getLayer(hoverOutlineId)) map.current.setLayoutProperty(hoverOutlineId, 'visibility', 'visible');\n  }, [uploadedGeojson, selectedIndicator, selectedProperty]);\n\n  const reprocessLastCsv = async (indicator, scale) => {\n    const file = lastCsvFileRef.current;\n    if (!file || !indicator || !scale) return;\n    setUploading(true);\n    try {\n      const form = new FormData();\n      form.append('indicator', indicator.toLowerCase());\n      form.append('scale', scale.toLowerCase());\n      form.append('file', file);\n      const attempts = [];\n      const base = process.env.REACT_APP_API_URL;\n      if (base) attempts.push(`${base}/generate`);\n      attempts.push('/generate');\n      if (typeof window !== 'undefined') {\n        const proto = window.location.protocol;\n        const host = window.location.hostname;\n        attempts.push(`${proto}//${host}:8000/generate`);\n      }\n      attempts.push('http://localhost:8000/generate');\n\n      let res; let lastErr;\n      for (const url of attempts) {\n        try {\n          res = await fetch(url, { method: 'POST', body: form });\n          if (res.ok) break;\n          const text = await res.text();\n          lastErr = new Error(`HTTP ${res.status} at ${url}: ${text}`);\n        } catch (err) { lastErr = err; }\n      }\n      if (!res || !res.ok) throw lastErr || new Error('Upload failed');\n      const geojson = await res.json();\n      setUploadedGeojson(geojson);\n      setSelectedProperty(null);\n    } catch (err) {\n      console.error(err);\n      const msg = `${err?.message || ''}`;\n      // If backend returned a 400 with our scale mismatch message, show a friendlier alert\n      if (/scale mismatch|spatial scale/i.test(msg)) {\n        alert('The selected Spatial scale does not match the identifiers in your CSV. Please choose the correct Spatial scale and try again.');\n      } else {\n        alert(`Failed to reprocess with the new Spatial scale. ${msg}`);\n      }\n    } finally {\n      setUploading(false);\n    }\n  };\n\n  // When spatial scale changes, reprocess the last uploaded CSV (if any)\n  useEffect(() => {\n    if (lastCsvFileRef.current && selectedIndicator && selectedScale) {\n      reprocessLastCsv(selectedIndicator, selectedScale);\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [selectedScale]);\n\n  const handleFileChange = async (e) => {\n    const file = e.target.files?.[0];\n    if (!file || !selectedIndicator || !selectedScale) {\n      if (!selectedScale) alert('Please select a spatial scale (SA1 / MB / DZN) before uploading.');\n      return;\n    }\n    lastCsvFileRef.current = file; // remember for future reprocessing\n    setUploading(true);\n    try {\n      const form = new FormData();\n      form.append('indicator', selectedIndicator.toLowerCase());\n      form.append('scale', selectedScale.toLowerCase());\n      form.append('file', file);\n      const attempts = [];\n      const base = process.env.REACT_APP_API_URL;\n      if (base) attempts.push(`${base}/generate`);\n      // CRA dev proxy\n      attempts.push('/generate');\n      // Same host on port 8000\n      if (typeof window !== 'undefined') {\n        const proto = window.location.protocol;\n        const host = window.location.hostname;\n        attempts.push(`${proto}//${host}:8000/generate`);\n      }\n      // Explicit localhost\n      attempts.push('http://localhost:8000/generate');\n\n      let res;\n      let lastErr;\n      for (const url of attempts) {\n        try {\n          res = await fetch(url, { method: 'POST', body: form });\n          if (res.ok) break;\n          const text = await res.text();\n          lastErr = new Error(`HTTP ${res.status} at ${url}: ${text}`);\n        } catch (err) {\n          lastErr = err;\n        }\n      }\n      if (!res || !res.ok) throw lastErr || new Error('Upload failed');\n      const geojson = await res.json();\n      setUploadedGeojson(geojson);\n      setSelectedProperty(null); // Reset selection on new upload\n    } catch (err) {\n      console.error(err);\n      const msg = `${err?.message || ''}`;\n      if (/scale mismatch|spatial scale/i.test(msg)) {\n        alert('The selected Spatial scale does not match the identifiers in your CSV. Please choose the correct Spatial scale and try again.');\n      } else {\n        alert(`Failed to generate GeoJSON from CSV. ${msg}`);\n      }\n    } finally {\n      setUploading(false);\n      // Reset file input to allow re-upload of same file\n      e.target.value = '';\n    }\n  };\n\n  // (All narrative, search, and export logic removed)\n\n  // --- RENDER METHOD ---\n  return (\n    <div style={{ position: 'relative', width: '100%', height: 'calc(100vh - 78px)' }}>\n      <div ref={mapContainer} style={{ position: 'absolute', width: '100%', height: '100%' }} />\n      {/* Left overlay with dropdown and file upload */}\n      <div style={{ position: 'absolute', top: '1rem', left: '1rem', backgroundColor: 'white', padding: '1rem', borderRadius: '0.5rem', boxShadow: '0 4px 6px rgba(0,0,0,0.1)', width: '320px', zIndex: 10 }}>\n        <h3 style={{ fontSize: '1.125rem', fontWeight: 600, marginBottom: '0.5rem' }}>Select Indicator</h3>\n        <select\n          value={selectedIndicator || ''}\n          onChange={(e) => setSelectedIndicator(e.target.value || null)}\n          style={{ width: '100%', padding: '0.5rem', border: '1px solid #D1D5DB', borderRadius: '0.375rem', marginBottom: '0.75rem' }}\n        >\n          <option value=\"\">Select</option>\n          <option value=\"Education\">Education</option>\n          <option value=\"Employment\">Employment</option>\n          <option value=\"Income\">Income</option>\n          <option value=\"POB\">POB</option>\n          <option value=\"Occupation\">Occupation</option>\n          <option value=\"Total number of jobs\">Total number of jobs</option>\n          <option value=\"Industry specialisation\">Industry specialisation</option>\n        </select>\n        <label style={{ display: 'block', fontSize: '0.9rem', marginBottom: '0.25rem' }}>Spatial scale</label>\n        <select\n          value={selectedScale || ''}\n          onChange={(e) => setSelectedScale(e.target.value || null)}\n          style={{ width: '100%', padding: '0.5rem', border: '1px solid #D1D5DB', borderRadius: '0.375rem', marginBottom: '0.75rem' }}\n        >\n          <option value=\"\">Select scale</option>\n          <option value=\"sa1\">SA1 level</option>\n          <option value=\"mb\">MB level</option>\n          <option value=\"dzn\">DZN level</option>\n        </select>\n  <label style={{ display: 'block', fontSize: '0.9rem', marginBottom: '0.5rem' }}>Upload CSV for selected indicator</label>\n        <input type=\"file\" accept=\".csv,text/csv\" onChange={handleFileChange} disabled={!selectedIndicator || !selectedScale || uploading} />\n        {uploading && <div style={{ marginTop: '0.5rem', fontSize: '0.85rem' }}>Processing</div>}\n\n        {/* Property selector for uploaded GeoJSON */}\n        {uploadedGeojson && propertyOptions.length > 0 && (\n          <div style={{ marginTop: '0.75rem' }}>\n            <label style={{ display: 'block', fontSize: '0.9rem', marginBottom: '0.25rem' }}>Property to visualize</label>\n            <select\n              value={selectedProperty || ''}\n              onChange={(e) => setSelectedProperty(e.target.value || null)}\n              style={{ width: '100%', padding: '0.5rem', border: '1px solid #D1D5DB', borderRadius: '0.375rem' }}\n            >\n              {propertyOptions.map(k => (\n                <option key={k} value={k}>{k}</option>\n              ))}\n            </select>\n          </div>\n        )}\n      </div>\n\n      {/* Bottom-right dynamic legend tied to selectedProperty */}\n      {legendInfo && (\n        <div style={{ position: 'absolute', right: '1rem', bottom: '2.3rem', backgroundColor: 'white', padding: '0.75rem', borderRadius: '0.5rem', boxShadow: '0 4px 6px rgba(0,0,0,0.1)', zIndex: 10 }}>\n          <div style={{ fontWeight: 600, fontSize: '0.95rem', marginBottom: '0.5rem' }}>{legendInfo.title}</div>\n          <div style={{ display: 'flex', flexDirection: 'column', gap: '4px' }}>\n            {legendInfo.ranges.map((r, i) => {\n              const fmt = (x) => {\n                const n = Number(x);\n                if (!Number.isFinite(n)) return String(x);\n                const abs = Math.abs(n);\n                const digits = abs >= 100 ? 0 : abs >= 10 ? 1 : 2;\n                return n.toLocaleString(undefined, { maximumFractionDigits: digits });\n              };\n              return (\n                <div key={i} style={{ display: 'flex', alignItems: 'center', gap: 8 }}>\n                  <div style={{ width: 18, height: 12, backgroundColor: r.color, border: '1px solid #ccc' }} />\n                  <div style={{ fontSize: '0.85rem' }}>{fmt(r.min)}  {fmt(r.max)}</div>\n                </div>\n              );\n            })}\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n// --- END: MAP COMPONENT ---"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}